# 라이브 DB 스키마 적용 가이드

이 문서는 로컬 개발 환경에서 생성하고 테스트한 DB 스키마 변경 사항(마이그레이션 파일)을 라이브(배포) Supabase 프로젝트에 안전하게 적용하는 절차를 설명합니다.

## 1. 전제 조건

- 로컬 마이그레이션 파일이 `supabase/migrations/` 폴더에 존재해야 합니다.
- `npx supabase link` 명령어를 통해 라이브 프로젝트와 연결이 완료된 상태여야 합니다.
- **로컬에서 충분한 테스트**를 거쳐 스키마에 오류가 없는지 확인해야 합니다.

---

## 2. 보안 및 준비 사항

> [!CAUTION]
> **라이브 DB 작업 전 필수 확인**
> 1. **백업**: 중요한 작업 전에는 Supabase 대시보드(Database -> Backups)에서 백업 상태를 확인하세요.
> 2. **변경 범위 확인**: 마이그레이션 파일 내용을 한 번 더 검토하여 기존 데이터를 삭제하는 로직(`DROP TABLE` 등)이 포함되어 있지 않은지 확인하세요.

---

## 3. 적용 단계

### 1단계: 로컬과 라이브 스키마 차이 확인 (Dry Run)
실제로 적용하기 전에, 어떤 변화가 일어날지 미리 SQL 형태로 확인해 볼 수 있습니다.
```bash
npx supabase db diff --linked
```
이 명령어는 로컬 파일과 라이브 DB를 비교하여 적용되지 않은 차이점을 보여줍니다.

### 2단계: 라이브 DB에 스키마 푸시
로컬에 새로 작성된 마이그레이션 파일들만 라이브 DB에 순차적으로 적용합니다.
```bash
npx supabase db push
```

- 이 명령어는 라이브 DB의 마이그레이션 이력을 확인하고, 아직 실행되지 않은 파일들만 안전하게 실행합니다.
- 성공하면 라이브 Supabase 대시보드에서 `insights` 등 새로운 테이블을 확인하실 수 있습니다.

---

## 4. 적용 실패 시 조치

만약 `db push` 중 에러가 발생한다면:
1. 에러 메시지를 확인하여 이미 존재하는 객체(Table, Policy 등)와의 충돌인지 확인합니다.
2. 라이브 DB 대시보드에서 직접 SQL을 실행하여 해결하거나, 마이그레이션 파일을 수정하여 다시 시도합니다.

---

## 5. 자주 쓰는 명령어 요약

| 명령어 | 용도 |
| :--- | :--- |
| `npx supabase db push` | 로컬 변경 사항을 라이브 DB에 반영 |
| `npx supabase db remote commit` | 라이브 DB의 상태를 로컬 마이그레이션 파일로 캡처 |
| `npx supabase status` | 연결된 프로젝트 정보 확인 |
